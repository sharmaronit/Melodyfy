<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Explore — Melodyfy</title>
<script>
(function(){const t=localStorage.getItem('bf_token');if(!t){location.href='index.html';return;}try{const p=JSON.parse(atob(t.split('.')[1]));if(p.exp&&p.exp<Date.now()/1000){localStorage.removeItem('bf_token');location.href='index.html';}}catch(e){localStorage.removeItem('bf_token');location.href='index.html';}})();
</script>
<style>
:root{--bg:#07070a;--bg-canvas:#07070a;--bg-overlay:#0e0e12;--bg-inset:#050508;--border:#2e2e34;--border-muted:#1e1e24;--text-primary:#E8E4DC;--text-secondary:#C9C4BA;--text-muted:#7a7a82;--accent:#EDE8DF;--accent-hover:#F0EDE6;--green-btn:#EDE8DF;--green-hover:#F0EDE6;--green-accent:#EDE8DF;--green-bright:#E8E4DC;--blue:#E8E4DC;--orange:#f0883e;--red:#f87171;--purple:#bc8cff;}
*{margin:0;padding:0;box-sizing:border-box;}html{scroll-behavior:smooth;}
body{background:var(--bg-canvas);color:var(--text-primary);font-family:'Space Grotesk',sans-serif;line-height:1.5;}
h1,h2,h3{font-family:'Archivo Black',sans-serif;color:var(--accent);}
.glass{background:rgba(7,7,10,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(237,232,223,.4);box-shadow:0 8px 32px rgba(0,0,0,.3),inset 0 1px 0 rgba(237,232,223,.12);border-radius:12px;}@supports not(backdrop-filter:blur(12px)){.glass{background:#0b0b0f;border:1px solid #4A4A55;}}
.page{max-width:1200px;margin:0 auto;padding:32px 24px;}
/* Filters */
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:24px;}
.filter-bar input,.filter-bar select{background:var(--bg-overlay);border:1px solid var(--border);border-radius:6px;padding:7px 12px;color:var(--text-primary);font-size:14px;outline:none;transition:border-color .15s;}
.filter-bar input:focus,.filter-bar select:focus{border-color:var(--blue);}
.filter-bar input[type=search]{flex:1;min-width:200px;}
select option{background:var(--bg-overlay);}
/* Repo grid */
.repo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;}
.repo-card{padding:18px 20px;background:var(--bg-overlay);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:border-color .2s,transform .2s;}
.repo-card:hover{border-color:rgba(237,232,223,.4);transform:translateY(-2px);}
.repo-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.repo-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#EDE8DF,#1a1a20);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;}
.repo-owner{font-size:12px;color:var(--text-muted);}
.repo-name{font-size:15px;font-weight:600;color:var(--blue);text-decoration:none;display:block;margin:4px 0 4px;}
.repo-name:hover{text-decoration:underline;}
.repo-desc{font-size:13px;color:var(--text-muted);margin-bottom:12px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.repo-meta{display:flex;gap:12px;font-size:12px;color:var(--text-muted);flex-wrap:wrap;align-items:center;}
.tag{display:inline-flex;padding:2px 8px;background:rgba(237,232,223,.12);border:1px solid rgba(237,232,223,.25);border-radius:99px;font-size:11px;color:var(--green-accent);}
.star-btn{display:inline-flex;align-items:center;gap:4px;background:rgba(177,186,196,.05);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:12px;color:var(--text-muted);cursor:pointer;transition:all .15s;}
.star-btn:hover{border-color:var(--orange);color:var(--orange);}
.star-btn.starred{background:rgba(240,136,62,.1);border-color:rgba(240,136,62,.3);color:var(--orange);}
.fork-btn{display:inline-flex;align-items:center;gap:4px;background:rgba(88,166,255,.05);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:12px;color:var(--text-muted);cursor:pointer;transition:all .15s;}
.fork-btn:hover{border-color:var(--blue);color:var(--blue);}
.load-more-wrap{display:flex;justify-content:center;margin-top:28px;}
.empty-state{text-align:center;padding:64px 24px;color:var(--text-muted);}
.empty-state .icon{font-size:3rem;margin-bottom:16px;}
.fade-in{opacity:0;transform:translateY(10px);transition:opacity .4s ease,transform .4s ease;}
.fade-in.visible{opacity:1;transform:none;}
@media(max-width:768px){.repo-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div id="nav-root"></div>

<main class="page">
<div style="margin-bottom:24px;">
<h1 style="font-size:1.5rem;font-weight:700;margin-bottom:4px;">Explore Melodyfy</h1>
<p style="color:var(--text-muted);font-size:14px;">Discover beats, fork projects, and find your sound.</p>
</div>

<!-- Filters -->
<div class="filter-bar">
<input type="search" id="search-q" placeholder="Search repositories, beats, producers…" oninput="debouncedSearch(this.value)"/>
<select id="filter-mood" onchange="loadExplore()">
<option value="">All moods</option>
<option value="EDM / Club Banger">EDM / Club Banger</option>
<option value="Trap / Hip-Hop">Trap / Hip-Hop</option>
<option value="Lo-fi Chill">Lo-fi Chill</option>
<option value="Synthwave">Synthwave</option>
<option value="Deep House">Deep House</option>
<option value="Drum and Bass">Drum and Bass</option>
<option value="Ambient">Ambient</option>
<option value="Phonk">Phonk</option>
<option value="Calm Piano">Calm Piano</option>
<option value="Acoustic Guitar">Acoustic Guitar</option>
<option value="Jazz">Jazz</option>
<option value="Blues">Blues</option>
<option value="Orchestral">Orchestral</option>
<option value="R&amp;B / Soul">R&amp;B / Soul</option>
<option value="Epic Cinematic">Epic Cinematic</option>
<option value="Metal">Metal</option>
<option value="Indie Rock">Indie Rock</option>
<option value="Afrobeats">Afrobeats</option>
<option value="Meditation">Meditation</option>
<option value="Nature Sounds">Nature Sounds</option>
<option value="Sleep Drone">Sleep Drone</option>
<option value="Bossa Nova">Bossa Nova</option>
<option value="8-Bit Game">8-Bit Game</option>
<option value="Middle Eastern">Middle Eastern</option>
</select>
<select id="filter-sort" onchange="loadExplore()">
<option value="popular">Most Popular</option>
<option value="new">Newest</option>
<option value="trending">Trending</option>
</select>
<select id="filter-bpm" onchange="loadExplore()">
<option value="">Any BPM</option>
<option value="slow">Slow (40–80)</option>
<option value="medium">Medium (80–120)</option>
<option value="fast">Fast (120–180)</option>
<option value="very_fast">Very Fast (180+)</option>
</select>
</div>

<!-- Grid -->
<div id="explore-grid" class="repo-grid"></div>

<!-- Load More -->
<div class="load-more-wrap">
<button class="btn btn-ghost" id="load-more-btn" onclick="loadMore()" style="display:none;">Load more</button>
</div>

<div id="empty-state" class="empty-state" style="display:none;">
<div class="icon"></div>
<div style="font-size:18px;font-weight:600;margin-bottom:8px;">No beats found</div>
<div style="margin-bottom:24px;">Try a different search or mood filter.</div>
<a href="studio.html" class="btn btn-green">Create a Beat</a>
</div>
</main>

<script>
const API='http://localhost:8000';
const token=localStorage.getItem('bf_token');
const headers={'Authorization':`Bearer ${token}`,'Content-Type':'application/json'};
let _offset=0; const LIMIT=12;
let _debounceTimer=null;
let _starState={};

function signOut(){localStorage.removeItem('bf_token');localStorage.removeItem('bf_user');location.href='index.html';}

function debouncedSearch(q){ clearTimeout(_debounceTimer); _debounceTimer=setTimeout(()=>loadExplore(),400); }

async function loadExplore(append=false){
  if(!append){ _offset=0; }
  const q=document.getElementById('search-q').value.trim();
  const mood=document.getElementById('filter-mood').value;
  const sort=document.getElementById('filter-sort').value;
  const bpmFilter=document.getElementById('filter-bpm').value;
  let bpmMin='', bpmMax='';
  if(bpmFilter==='slow'){bpmMin=40;bpmMax=80;}
  else if(bpmFilter==='medium'){bpmMin=80;bpmMax=120;}
  else if(bpmFilter==='fast'){bpmMin=120;bpmMax=180;}
  else if(bpmFilter==='very_fast'){bpmMin=180;bpmMax=300;}

  const params=new URLSearchParams({sort,limit:LIMIT,offset:_offset});
  if(q) params.set('q',q);
  if(mood) params.set('mood',mood);
  if(bpmMin) params.set('bpm_min',bpmMin);
  if(bpmMax) params.set('bpm_max',bpmMax);

  const grid=document.getElementById('explore-grid');
  if(!append) grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:48px;color:var(--text-muted);">Loading…</div>';

  try{
  const r=await fetch(`${API}/projects/search?${params}`,{headers});
  const d=await r.json();
  const repos=d.repositories||d||[];
  if(!append) grid.innerHTML='';

  if(!repos.length&&!append){
  document.getElementById('empty-state').style.display='block';
  document.getElementById('load-more-btn').style.display='none';
  return;
  }
  document.getElementById('empty-state').style.display='none';

  repos.forEach(repo=>{
  const card=document.createElement('div');
  card.className='repo-card fade-in';
  // owner may be a plain string (API) or an object {username:...}
  const ownerName = typeof repo.owner==='string' ? repo.owner : (repo.owner?.username||'unknown');
  const starClass=_starState[repo.id]?'star-btn starred':'star-btn';
  card.innerHTML=`
<div class="repo-card-top">
<div style="display:flex;align-items:center;gap:8px;">
<div class="repo-avatar">${ownerName[0].toUpperCase()}</div>
<span class="repo-owner">${ownerName}</span>
</div>
<div style="display:flex;gap:6px;">
  ${repo.mood?`<span class="tag">${repo.mood}</span>`:''}
</div>
</div>
<a class="repo-name" href="project_tree.html?project=${repo.id}" onclick="event.stopPropagation()">${repo.name}</a>
<div class="repo-desc">${repo.description||'No description provided.'}</div>
<div class="repo-meta">
  ${repo.bpm_hint?`<span>♩ ${repo.bpm_hint} BPM</span>`:''}
<button class="${starClass}" id="star-${repo.id}" onclick="event.stopPropagation();toggleStar('${repo.id}')">⭐ ${repo.star_count||0}</button>
<button class="fork-btn" onclick="event.stopPropagation();forkRepo('${repo.id}')">Fork</button>
<span>▶ ${repo.play_count||0}</span>
</div>`;
  card.onclick=()=>location.href=`project_tree.html?project=${repo.id}`;
  grid.appendChild(card);
  setTimeout(()=>card.classList.add('visible'),50);
  });

  _offset+=repos.length;
  document.getElementById('load-more-btn').style.display=repos.length===LIMIT?'inline-flex':'none';
  }catch(e){
  if(!append) grid.innerHTML=`<div style="grid-column:1/-1;padding:32px;text-align:center;color:var(--red);">Error loading repos: ${e.message}</div>`;
  }
}

function loadMore(){ loadExplore(true); }

async function toggleStar(repoId){
  const btn=document.getElementById(`star-${repoId}`);
  const starred=_starState[repoId];
  try{
  const r=await fetch(`${API}/projects/${repoId}/star`,{method:starred?'DELETE':'POST',headers});
  if(r.ok){
  _starState[repoId]=!starred;
  const current=parseInt(btn.textContent.replace(/[^0-9]/g,''))||0;
  btn.className=_starState[repoId]?'star-btn starred':'star-btn';
  btn.textContent=`⭐ ${current+(_starState[repoId]?1:-1)}`;
  }
  }catch(e){console.error(e);}
}

async function forkRepo(repoId){
  try{
  const r=await fetch(`${API}/projects/${repoId}/fork`,{method:'POST',headers});
  if(r.ok){
  const d=await r.json();
  if(confirm(`Forked! Go to your new project?`)) location.href=`project_tree.html?project=${d.id}`;
  } else { const e=await r.json(); alert('Fork failed: '+(e.detail||r.status)); }
  }catch(e){alert('Fork error: '+e.message);}
}

loadExplore();

const obs=new IntersectionObserver(e=>e.forEach(el=>{if(el.isIntersecting)el.target.classList.add('visible');}),{threshold:.1});
new MutationObserver(()=>document.querySelectorAll('.fade-in:not(.visible)').forEach(el=>obs.observe(el))).observe(document.getElementById('explore-grid'),{childList:true});
</script>
<script src="nav.js"></script>
</body>
</html>
