<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Repository â€” Melodyfy</title>
<style>
:root{--bg:#07070a;--bg-canvas:#07070a;--bg-overlay:#0e0e12;--bg-inset:#050508;--border:#2e2e34;--border-muted:#1e1e24;--text-primary:#E8E4DC;--text-secondary:#C9C4BA;--text-muted:#7a7a82;--accent:#EDE8DF;--accent-hover:#F0EDE6;--green-btn:#EDE8DF;--green-hover:#F0EDE6;--green-accent:#EDE8DF;--green-bright:#E8E4DC;--blue:#E8E4DC;--orange:#f0883e;--red:#f87171;--purple:#bc8cff;}
*{margin:0;padding:0;box-sizing:border-box;}html{scroll-behavior:smooth;}
body{background:var(--bg-canvas);color:var(--text-primary);font-family:'Space Grotesk',sans-serif;line-height:1.5;}
h1,h2,h3{font-family:'Archivo Black',sans-serif;color:var(--accent);}

/* â”€â”€ NAV â”€â”€ */
.btn-star{background:rgba(227,179,65,.12);border-color:rgba(227,179,65,.3);color:var(--yellow);}
.btn-star:hover{background:rgba(227,179,65,.22);}
.btn-fork{background:rgba(88,166,255,.12);border-color:rgba(88,166,255,.3);color:var(--blue);}
.btn-fork:hover{background:rgba(88,166,255,.22);}
.btn-xs{padding:2px 8px;font-size:11px;}

/* â”€â”€ LAYOUT â”€â”€ */
.page{max-width:1100px;margin:0 auto;padding:24px 24px 60px;}

/* â”€â”€ REPO HEADER â”€â”€ */
.repo-header{display:flex;gap:20px;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;}
.repo-header-main{flex:1;min-width:0;}
.breadcrumb{font-size:20px;font-weight:600;display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
.breadcrumb a{color:var(--blue);text-decoration:none;}.breadcrumb a:hover{text-decoration:underline;}
.breadcrumb-sep{color:var(--text-muted);font-weight:300;}
.repo-desc{font-size:14px;color:var(--text-muted);margin-bottom:12px;line-height:1.6;}
.repo-meta-tags{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;}
.tag{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:99px;font-size:12px;font-weight:500;}
.tag-vis{background:rgba(237,232,223,.12);border:1px solid rgba(237,232,223,.25);color:var(--green-accent);}
.tag-private{background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.2);color:var(--red);}
.tag-mood{background:rgba(88,166,255,.1);border:1px solid rgba(88,166,255,.2);color:var(--blue);}
.tag-bpm{background:rgba(188,140,255,.1);border:1px solid rgba(188,140,255,.2);color:var(--purple);}
.tag-key{background:rgba(240,136,62,.1);border:1px solid rgba(240,136,62,.2);color:var(--orange);}
.tag-fork{background:rgba(88,166,255,.08);border:1px solid rgba(88,166,255,.15);color:var(--text-muted);font-size:11px;}
.repo-stats{display:flex;gap:16px;font-size:13px;color:var(--text-muted);margin-top:6px;}
.repo-stat{display:flex;align-items:center;gap:4px;}
.repo-actions{display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap;}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:28px;gap:0;overflow-x:auto;}
.tab-btn{padding:12px 20px;font-size:14px;font-weight:500;cursor:pointer;background:none;border:none;color:var(--text-muted);border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap;display:flex;align-items:center;gap:6px;}
.tab-btn:hover{color:var(--text-primary);}
.tab-btn.active{color:var(--text-primary);border-bottom-color:var(--orange);}
.tab-content{display:none;}.tab-content.active{display:block;}

/* â”€â”€ COMMITS TAB â”€â”€ */
.featured-player{background:rgba(37,37,37,.7);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:24px;}
.featured-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.featured-title{font-size:18px;font-weight:600;margin-bottom:4px;}
.featured-meta{font-size:13px;color:var(--text-muted);margin-bottom:14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
audio{width:100%;height:36px;border-radius:6px;accent-color:var(--orange);}
.commit-list{display:flex;flex-direction:column;gap:0;}
.commit-row{display:flex;align-items:flex-start;gap:16px;padding:16px 0;border-bottom:1px solid var(--border-muted);position:relative;}
.commit-row:last-child{border:none;}
.commit-row::before{content:'';position:absolute;left:17px;top:50px;bottom:-16px;width:2px;background:var(--border-muted);}
.commit-row:last-child::before{display:none;}
.commit-dot{width:36px;height:36px;border-radius:50%;background:var(--bg-overlay);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.commit-dot.root{border-color:var(--green-accent);}
.commit-body{flex:1;min-width:0;}
.commit-row-top{display:flex;align-items:flex-start;gap:10px;flex-wrap:wrap;margin-bottom:6px;}
.commit-hash{font-family:ui-monospace,'SFMono-Regular',monospace;font-size:12px;color:var(--blue);background:rgba(88,166,255,.1);border:1px solid rgba(88,166,255,.2);padding:2px 8px;border-radius:6px;flex-shrink:0;text-decoration:none;}
.commit-hash:hover{background:rgba(88,166,255,.2);}
.commit-msg{font-size:15px;font-weight:600;color:var(--text-primary);flex:1;min-width:0;word-break:break-word;}
.commit-bottom{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--text-muted);}
.commit-audio-row{margin-top:10px;}
.commit-actions{display:flex;gap:6px;flex-shrink:0;margin-left:auto;}
.commit-actions .btn{padding:3px 10px;font-size:12px;}
.empty-state{text-align:center;padding:80px 20px;color:var(--text-muted);}
.empty-state .emoji{font-size:3rem;margin-bottom:12px;}
.empty-state p{font-size:15px;margin-bottom:8px;}

/* â”€â”€ TREE TAB â”€â”€ */
.tree-frame-wrap{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--bg-inset);}
.tree-frame-wrap iframe{width:100%;height:550px;border:none;display:block;}

/* â”€â”€ COMMENTS TAB â”€â”€ */
.comment-input-area{background:rgba(37,37,37,.6);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px;}
.comment-input-area textarea{width:100%;background:var(--bg-inset);border:1px solid var(--border);border-radius:6px;padding:10px 12px;color:var(--text-primary);font-size:14px;font-family:inherit;line-height:1.5;resize:vertical;outline:none;min-height:80px;}
.comment-input-area textarea:focus{border-color:var(--blue);}
.comment-input-footer{display:flex;justify-content:flex-end;margin-top:10px;}
.comment-list{display:flex;flex-direction:column;gap:16px;}
.comment-card{background:rgba(37,37,37,.5);border:1px solid var(--border-muted);border-radius:10px;padding:14px 16px;}
.comment-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:12px;color:var(--text-muted);}
.comment-author{font-weight:600;color:var(--text-primary);font-size:13px;}
.comment-dot{font-size:8px;}
.comment-body{font-size:14px;line-height:1.6;white-space:pre-wrap;}
.comment-del{margin-left:auto;cursor:pointer;background:none;border:none;color:var(--text-muted);font-size:12px;padding:2px 6px;border-radius:4px;}
.comment-del:hover{background:rgba(248,81,73,.15);color:var(--red);}
.no-comments{text-align:center;padding:48px;color:var(--text-muted);font-size:14px;}
/* select commit for comments */
.commit-picker{margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:13px;flex-wrap:wrap;}
.commit-picker select{background:var(--bg-inset);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text-primary);font-size:13px;outline:none;}
.commit-picker select:focus{border-color:var(--blue);}

/* â”€â”€ STATUS / LOADING â”€â”€ */
.status-line{padding:10px 14px;border-radius:8px;font-size:13px;margin-top:8px;}
.status-line.ok{background:rgba(63,185,80,.1);border:1px solid rgba(63,185,80,.3);color:var(--green-accent);}
.status-line.err{background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);color:var(--red);}
.status-line.info{background:rgba(88,166,255,.1);border:1px solid rgba(88,166,255,.3);color:var(--blue);}
.loading-pulse{animation:pulse 1.4s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.skeleton{height:20px;background:var(--border);border-radius:4px;animation:pulse 1.4s ease-in-out infinite;}

/* â”€â”€ COLLABS MINI LIST â”€â”€ */
.collabs-strip{display:flex;gap:6px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--text-muted);}
.collab-avatar{width:24px;height:24px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--text-primary);border:2px solid var(--bg-canvas);}

.fade-in{opacity:0;transform:translateY(8px);transition:opacity .35s ease,transform .35s ease;}
.fade-in.visible{opacity:1;transform:none;}
@media(max-width:768px){.repo-actions{width:100%;}.commit-actions{width:100%;justify-content:flex-end;}.tabs{gap:0;}.tab-btn{padding:10px 12px;font-size:13px;}}
/* â”€â”€ VISUALIZER â”€â”€ */
.viz-wrap{width:100%;border-radius:8px;overflow:hidden;position:relative;background:#07070a;}
.viz-wrap-featured{height:90px;margin-bottom:14px;}
.viz-wrap-commit{height:60px;margin-bottom:8px;}
</style>
</head>
<body>
<div id="nav-root"></div>

<main class="page">
<!-- HEADER SKELETON (replaced once data loads) -->
<div id="repo-header-area">
<div class="repo-header">
<div class="repo-header-main">
<div class="skeleton" style="width:320px;height:26px;margin-bottom:8px;"></div>
<div class="skeleton" style="width:240px;height:14px;margin-bottom:12px;"></div>
<div style="display:flex;gap:6px;"><div class="skeleton" style="width:60px;height:22px;border-radius:99px;"></div><div class="skeleton" style="width:80px;height:22px;border-radius:99px;"></div></div>
</div>
<div style="display:flex;gap:8px;"><div class="skeleton" style="width:80px;height:30px;border-radius:6px;"></div><div class="skeleton" style="width:80px;height:30px;border-radius:6px;"></div></div>
</div>
</div>

<!-- TABS -->
<div class="tabs">
<button class="tab-btn active" onclick="switchTab('commits',this)"><span id="tab-commits-label">Commits</span></button>
<button class="tab-btn" onclick="switchTab('tree',this)">Tree</button>
<button class="tab-btn" onclick="switchTab('comments',this)"><span id="tab-comments-label">Comments</span></button>
</div>

<!-- COMMITS TAB -->
<div id="tab-commits" class="tab-content active">
<div id="commits-area">
<div style="display:flex;flex-direction:column;gap:10px;">
<div class="skeleton" style="height:100px;border-radius:12px;"></div>
<div class="skeleton" style="height:60px;border-radius:8px;"></div>
<div class="skeleton" style="height:60px;border-radius:8px;"></div>
</div>
</div>
</div>

<!-- TREE TAB -->
<div id="tab-tree" class="tab-content">
<div class="tree-frame-wrap">
<iframe id="tree-iframe" title="Commit Tree" loading="lazy"></iframe>
</div>
</div>

<!-- COMMENTS TAB -->
<div id="tab-comments" class="tab-content">
<div class="commit-picker">
<span>Comment on:</span>
<select id="comment-commit-select" onchange="loadComments(this.value)">
<option value="">Select a commitâ€¦</option>
</select>
</div>

<div class="comment-input-area" id="comment-input-area" style="display:none;">
<textarea id="comment-body" placeholder="Leave a note, feedback, or idea about this commitâ€¦"></textarea>
<div class="comment-input-footer">
<button class="btn btn-green btn-sm" onclick="submitComment()">Comment</button>
</div>
<div id="comment-status"></div>
</div>

<div id="comments-list-area">
<div class="no-comments" id="comments-placeholder">Select a commit to see its comments.</div>
</div>
</div>
</main>

<script>
const API='http://localhost:8000';
const token=localStorage.getItem('bf_token');
const headers={'Authorization':`Bearer ${token}`,'Content-Type':'application/json'};
window._vizQueue = window._vizQueue || [];

let _repoId=null;
let _repoData=null; // full repo + commits
let _isOwner=false;
let _isStarred=false;
let _myUsername=null;

function signOut(){localStorage.removeItem('bf_token');localStorage.removeItem('bf_user');location.href='index.html';}

function switchTab(tab, btn){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  btn.classList.add('active');
  // Lazy-load tree iframe
  if(tab==='tree' && _repoId){
  const iframe=document.getElementById('tree-iframe');
  if(!iframe.src) iframe.src=`project_tree.html?project=${_repoId}&embed=1`;
  }
}

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function timeAgo(ts){
  if(!ts) return '';
  const s=Math.floor((Date.now()-new Date(ts))/1000);
  if(s<60) return `${s}s ago`;
  if(s<3600) return `${Math.floor(s/60)}m ago`;
  if(s<86400) return `${Math.floor(s/3600)}h ago`;
  return `${Math.floor(s/86400)}d ago`;
}
function truncate(s,n){return s&&s.length>n?s.slice(0,n)+'â€¦':s||'';}
function showStatus(id,msg,type){
  const el=document.getElementById(id);if(!el)return;
  el.className='status-line '+type;el.textContent=msg;el.style.display='block';
  if(type!=='info') setTimeout(()=>{el.style.display='none';},5000);
}
function moodEmoji(mood){
  const map={'EDM / Club Banger':'','Trap / Hip-Hop':'','Lo-fi Chill':'','Synthwave':'','Deep House':'','Drum and Bass':'','Ambient':'','Phonk':'','Calm Piano':'','Acoustic Guitar':'','Jazz':'','Blues':'','Orchestral':'','R&B / Soul':'','Epic Cinematic':'','Metal':'','Indie Rock':'','Afrobeats':'','Meditation':'','Nature Sounds':'','Sleep Drone':'','Bossa Nova':'','8-Bit Game':'','Middle Eastern':''};
  return (map[mood]||'')+' '+mood;
}

/* â”€â”€ Load current user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadMe(){
  if(!token) return;
  try{
  const r=await fetch(`${API}/auth/me`,{headers});
  if(r.ok){const d=await r.json();_myUsername=d.username;}
  }catch{}
}

/* â”€â”€ My repos picker (no ?id= in URL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadMyRepos(){
  const area=document.getElementById('repo-header-area');
  const mainEl=document.querySelector('main');

  // Hide tabs â€” not needed in picker mode
  document.querySelector('.tabs').style.display='none';
  document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');

  if(!token){
    area.innerHTML=`<div style="padding:48px 0;text-align:center;">
      <div style="font-size:32px;margin-bottom:12px;">ğŸµ</div>
      <h2 style="margin-bottom:8px;">Your Repositories</h2>
      <p style="color:var(--text-muted);margin-bottom:20px;">Sign in to view your projects.</p>
      <a href="index.html" class="btn btn-green">Sign In</a>
    </div>`;
    return;
  }

  area.innerHTML=`<div style="padding:24px 0 8px;">
    <h2 style="font-size:20px;margin-bottom:4px;">Your Repositories</h2>
    <p style="color:var(--text-muted);font-size:13px;">Select a project to open its repository.</p>
  </div>`;

  // Create a container for the project cards
  const listWrap=document.createElement('div');
  listWrap.id='my-repos-list';
  listWrap.style.cssText='display:flex;flex-direction:column;gap:12px;margin-top:16px;';
  listWrap.innerHTML='<div class="loading-pulse" style="padding:20px;color:var(--text-muted);">Loading your projectsâ€¦</div>';
  mainEl.appendChild(listWrap);

  try{
    const r=await fetch(`${API}/projects/mine`,{headers});
    if(!r.ok) throw new Error(r.status);
    const projects=await r.json();

    if(!projects.length){
      listWrap.innerHTML=`<div style="padding:40px;text-align:center;color:var(--text-muted);">
        <div style="font-size:28px;margin-bottom:12px;">ğŸ“‚</div>
        <p>No projects yet. Generate a beat in Studio to create your first one!</p>
        <a href="studio.html" class="btn btn-green" style="margin-top:16px;display:inline-block;">Open Studio</a>
      </div>`;
      return;
    }

    listWrap.innerHTML=projects.map(p=>`
      <div class="glass fade-in" style="padding:16px 20px;cursor:pointer;transition:background .15s;" onclick="location.href='repo.html?id=${p.id}'" onmouseover="this.style.background='rgba(237,232,223,.06)'" onmouseout="this.style.background=''">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:0;">
            <div style="font-size:15px;font-weight:600;color:var(--accent);margin-bottom:3px;">${p.name||'Untitled'}</div>
            <div style="font-size:12px;color:var(--text-muted);">${p.description||p.genre||''} ${p.bpm?'Â· '+p.bpm+' BPM':''} ${p.key?'Â· '+p.key:''}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;font-size:12px;color:var(--text-muted);flex-shrink:0;">
            ${p.visibility==='public'?'<span class="tag tag-vis">Public</span>':'<span class="tag tag-private">Private</span>'}
            <span>${p.commit_count||0} commit${p.commit_count!==1?'s':''}</span>
            <span style="color:var(--orange);">â†’</span>
          </div>
        </div>
      </div>`).join('');
    setTimeout(()=>listWrap.querySelectorAll('.fade-in').forEach((el,i)=>setTimeout(()=>el.classList.add('visible'),i*40)),50);
  }catch(e){
    listWrap.innerHTML=`<div style="padding:20px;color:var(--red);">Failed to load projects: ${e.message}</div>`;
  }
}

/* â”€â”€ Main load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadRepo(){
  const params=new URLSearchParams(location.search);
  _repoId=params.get('id');
  if(!_repoId){
    await loadMe();
    loadMyRepos();
    return;
  }
  try{
  const r=await fetch(`${API}/projects/${_repoId}`,{headers});
  if(!r.ok) throw new Error('Repository not found');
  _repoData=await r.json();
  document.title=`${_repoData.name} â€” Melodyfy`;
  renderHeader();
  renderCommits();
  populateCommentPicker();
  }catch(e){
  document.getElementById('repo-header-area').innerHTML=`<div style="padding:60px;text-align:center;color:var(--red);">Error: ${e.message}</div>`;
  }
}

/* â”€â”€ Render header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderHeader(){
  const r=_repoData;
  const latestCommit=r.commits&&r.commits[0];
  const latestBpm=latestCommit?.bpm;
  const latestKey=latestCommit?.key;
  const latestMood=latestCommit?.mood||(r.commits?.find(c=>c.mood))?.mood;

  // Check ownership
  try{const u=JSON.parse(localStorage.getItem('bf_user')||'{}');_isOwner=(u.username===r.owner);}catch{}

  let forkedBadge='';
  if(r.forked_from){
  forkedBadge=`<span class="tag tag-fork"> forked</span>`;
  }

  document.getElementById('repo-header-area').innerHTML=`
<div class="repo-header fade-in">
<div class="repo-header-main">
<div class="breadcrumb">
<span></span>
<a href="/ui/index.html">${r.owner||'unknown'}</a>
<span class="breadcrumb-sep">/</span>
<span>${r.name}</span>
  ${forkedBadge}
</div>
<div class="repo-desc">${r.description||'<em style="color:var(--text-muted)">No description provided.</em>'}</div>
<div class="repo-meta-tags">
<span class="tag ${r.is_public?'tag-vis':'tag-private'}">${r.is_public?' public':' private'}</span>
  ${latestMood?`<span class="tag tag-mood">${moodEmoji(latestMood)}</span>`:''}
  ${latestBpm?`<span class="tag tag-bpm">â™© ${Math.round(latestBpm)} BPM</span>`:''}
  ${latestKey?`<span class="tag tag-key"> ${latestKey}</span>`:''}
</div>
<div class="repo-stats">
<span class="repo-stat">â­<strong id="star-count">${r.star_count||0}</strong> stars</span>
<span class="repo-stat">â–¶ ${r.play_count||0} plays</span>
<span class="repo-stat"> ${r.commit_count||r.commits?.length||0} commits</span>
<span class="repo-stat"> updated ${timeAgo(r.updated_at)}</span>
</div>
</div>
<div class="repo-actions">
<button class="btn btn-star" id="star-btn" onclick="toggleStar()">â­ Star</button>
<button class="btn btn-fork" onclick="forkRepo()">Fork</button>
<a href="studio.html?repo_id=${r.id}" class="btn btn-green">Open in Studio</a>
</div>
</div>`;

  document.getElementById('tab-commits-label').textContent=`Commits (${r.commit_count||r.commits?.length||0})`;
  setTimeout(()=>document.querySelector('.repo-header.fade-in')?.classList.add('visible'),50);
}

/* â”€â”€ Render commits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCommits(){
  const commits=_repoData?.commits||[];
  const area=document.getElementById('commits-area');

  if(!commits.length){
  area.innerHTML=`<div class="empty-state">
<div class="emoji"></div>
<p>No commits yet</p>
<p style="font-size:13px;margin-bottom:20px;">Generate a beat in the Studio and commit it here.</p>
<a href="studio.html?repo_id=${_repoId}" class="btn btn-green">Open Studio</a>
</div>`;
  return;
  }

  const latest=commits[0];
  const audioSrc=`${API}${latest.audio_url}`;

  let html=`
<div class="featured-player fade-in">
<div class="featured-label">Latest Commit â€”<span style="font-family:monospace;color:var(--blue);">${latest.hash}</span></div>
<div class="featured-title">${latest.message||'Beat update'}</div>
<div class="featured-meta">
  ${latest.mood?`<span>${moodEmoji(latest.mood)}</span>`:''}
  ${latest.bpm?`<span>â™© ${Math.round(latest.bpm)} BPM</span>`:''}
  ${latest.key?`<span> ${latest.key}</span>`:''}
  ${latest.duration?`<span>â± ${Number(latest.duration).toFixed(1)}s</span>`:''}
<span>by<strong>${latest.author||'â€”'}</strong></span>
<span>${timeAgo(latest.created_at)}</span>
</div>
<div class="viz-wrap viz-wrap-featured" id="vw-featured"></div>
<audio controls src="${audioSrc}" id="audio-featured" preload="none" onplay="bumpPlay()" style="width:100%;height:36px;border-radius:6px;accent-color:var(--orange);"></audio>
</div>

<div class="commit-list">`;

  commits.forEach((c,i)=>{
  const isRoot=!c.parent_id;
  const src=`${API}${c.audio_url}`;
  const rollbackUrl=`studio.html?restore_beat=${encodeURIComponent(c.audio_url)}&parent_hash=${encodeURIComponent(c.hash)}&repo_id=${_repoId}`;
  html+=`
<div class="commit-row fade-in" style="animation-delay:${i*30}ms">
<div class="commit-dot${isRoot?' root':''}"></div>
<div class="commit-body">
<div class="commit-row-top">
<a class="commit-hash" href="project_tree.html?project=${_repoId}" title="View in tree">${c.hash}</a>
<span class="commit-msg">${c.message||'Beat update'}</span>
<div class="commit-actions">
<a href="${rollbackUrl}" class="btn btn-ghost btn-xs" title="Restore this version in Studio">â†© Restore</a>
<a href="studio.html?parent_hash=${encodeURIComponent(c.hash)}&repo_id=${_repoId}" class="btn btn-ghost btn-xs" title="Branch from this commit">Branch</a>
</div>
</div>
<div class="commit-bottom">
  ${c.mood?`<span>${moodEmoji(c.mood)}</span>`:''}
  ${c.bpm?`<span class="tag tag-bpm" style="font-size:11px;">â™© ${Math.round(c.bpm)} BPM</span>`:''}
  ${c.key?`<span class="tag tag-key" style="font-size:11px;"> ${c.key}</span>`:''}
  ${c.energy!=null?`<span> energy ${Number(c.energy).toFixed(2)}</span>`:''}
<span><strong>${c.author||'â€”'}</strong></span>
<span> ${timeAgo(c.created_at)}</span>
  ${isRoot?'<span style="color:var(--green-accent);font-weight:600;">root</span>':''}
</div>
<div class="commit-audio-row">
<div class="viz-wrap viz-wrap-commit" id="vw-${c.id}"></div>
<audio controls src="${src}" id="audio-${c.id}" preload="none" style="width:100%;height:28px;"></audio>
</div>
</div>
</div>`;
  });

  html+='</div>';
  area.innerHTML=html;

  // Mount visualizers (warm preset = fire/orange style)
  window._vizQueue.push({ wrapId:'vw-featured', audioId:'audio-featured', preset:'melodyfy', height:90 });
  commits.forEach(c=>{
    window._vizQueue.push({ wrapId:'vw-'+c.id, audioId:'audio-'+c.id, preset:'melodyfy', height:60 });
  });

  // Animate
  setTimeout(()=>{
  area.querySelectorAll('.fade-in').forEach((el,i)=>setTimeout(()=>el.classList.add('visible'),i*40));
  },50);
}

/* â”€â”€ Star / Fork â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function toggleStar(){
  if(!token){alert('Sign in to star repositories.');return;}
  const btn=document.getElementById('star-btn');
  const countEl=document.getElementById('star-count');
  try{
  if(_isStarred){
  await fetch(`${API}/projects/${_repoId}/star`,{method:'DELETE',headers});
  _isStarred=false;
  btn.textContent='â­ Star';
  btn.style.background='';
  countEl.textContent=Math.max(0,(parseInt(countEl.textContent)||0)-1);
  } else {
  const r=await fetch(`${API}/projects/${_repoId}/star`,{method:'POST',headers});
  if(r.ok){const d=await r.json();_isStarred=true;btn.textContent='â­ Unstar';btn.style.background='rgba(227,179,65,.3)';countEl.textContent=d.star_count||((parseInt(countEl.textContent)||0)+1);}
  }
  }catch(e){alert('Star failed: '+e.message);}
}

async function forkRepo(){
  if(!token){alert('Sign in to fork repositories.');return;}
  if(!confirm(`Fork "${_repoData?.name}" into your account?`)) return;
  try{
  const r=await fetch(`${API}/projects/${_repoId}/fork`,{method:'POST',headers});
  if(r.ok){
  const d=await r.json();
  if(confirm(`âœ“ Forked as "${d.name}"! Open it?`))
  location.href=`repo.html?id=${d.id}`;
  } else {
  const e=await r.json(); alert('Fork failed: '+(e.detail||r.status));
  }
  }catch(e){alert('Fork error: '+e.message);}
}

function bumpPlay(){
  fetch(`${API}/projects/${_repoId}/play`,{method:'POST'}).catch(()=>{});
}

/* â”€â”€ Comments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function populateCommentPicker(){
  const commits=_repoData?.commits||[];
  const sel=document.getElementById('comment-commit-select');
  commits.forEach(c=>{
  const o=document.createElement('option');
  o.value=c.id;
  o.textContent=`${c.hash} â€” ${truncate(c.message||'Beat update',40)}`;
  sel.appendChild(o);
  });
  // Pre-select latest if available
  if(commits.length){
  sel.value=commits[0].id;
  loadComments(commits[0].id);
  }
}

async function loadComments(commitId){
  if(!commitId) return;
  const area=document.getElementById('comments-list-area');
  const inputArea=document.getElementById('comment-input-area');
  area.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-muted);" class="loading-pulse">Loading commentsâ€¦</div>';
  if(token) inputArea.style.display='block'; else inputArea.style.display='none';
  try{
  const r=await fetch(`${API}/projects/${_repoId}/commits/${commitId}/comments`,{headers});
  if(!r.ok) throw new Error(r.status);
  const comments=await r.json();
  renderComments(comments, commitId);
  }catch(e){
  area.innerHTML=`<div style="padding:20px;color:var(--red);">Error loading comments: ${e.message}</div>`;
  }
}

function renderComments(comments, commitId){
  const area=document.getElementById('comments-list-area');
  document.getElementById('tab-comments-label').textContent=`Comments (${comments.length})`;
  if(!comments.length){
  area.innerHTML='<div class="no-comments">No comments yet. Be the first to leave one!</div>';
  return;
  }
  area.innerHTML=`<div class="comment-list">${
  comments.map(c=>{
  const canDel=_myUsername&&c.author===_myUsername;
  return `<div class="comment-card fade-in">
<div class="comment-header">
<div class="collab-avatar">${(c.author||'?')[0].toUpperCase()}</div>
<span class="comment-author">${c.author||'Unknown'}</span>
<span class="comment-dot">â€¢</span>
<span>${timeAgo(c.created_at)}</span>
  ${canDel?`<button class="comment-del" onclick="deleteComment('${c.id}','${commitId}')"></button>`:''}
</div>
<div class="comment-body">${escHtml(c.body)}</div>
</div>`;
  }).join('')
  }</div>`;
  setTimeout(()=>area.querySelectorAll('.fade-in').forEach(el=>el.classList.add('visible')),50);
}

async function submitComment(){
  const sel=document.getElementById('comment-commit-select');
  const commitId=sel.value;
  if(!commitId){alert('Select a commit first.');return;}
  const body=document.getElementById('comment-body').value.trim();
  if(!body){showStatus('comment-status','Comment cannot be empty.','err');return;}
  showStatus('comment-status','Postingâ€¦','info');
  try{
  const r=await fetch(`${API}/projects/${_repoId}/commits/${commitId}/comments`,{
  method:'POST',headers,body:JSON.stringify({body})
  });
  if(!r.ok){const e=await r.json();throw new Error(e.detail||'Failed');}
  document.getElementById('comment-body').value='';
  document.getElementById('comment-status').style.display='none';
  await loadComments(commitId);
  }catch(e){showStatus('comment-status','âœ— '+e.message,'err');}
}

async function deleteComment(commentId, commitId){
  if(!confirm('Delete this comment?')) return;
  try{
  const r=await fetch(`${API}/comments/${commentId}`,{method:'DELETE',headers});
  if(!r.ok){const e=await r.json();throw new Error(e.detail||'Failed');}
  await loadComments(commitId);
  }catch(e){alert('Delete failed: '+e.message);}
}

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
Promise.all([loadMe(), loadRepo()]);
</script>
<script src="nav.js"></script>
<script type="module" src="./visualizer.js"></script>
</body>
</html>
