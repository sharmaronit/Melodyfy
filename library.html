<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Library — Melodyfy</title>
<script>
(function(){const t=localStorage.getItem('bf_token');if(!t){location.href='index.html';return;}try{const p=JSON.parse(atob(t.split('.')[1]));if(p.exp&&p.exp<Date.now()/1000){localStorage.removeItem('bf_token');location.href='index.html';}}catch(e){localStorage.removeItem('bf_token');location.href='index.html';}})();
</script>
<style>
:root{--bg:#07070a;--bg-canvas:#07070a;--bg-overlay:#0e0e12;--bg-inset:#050508;--border:#2e2e34;--border-muted:#1e1e24;--text-primary:#E8E4DC;--text-secondary:#C9C4BA;--text-muted:#7a7a82;--accent:#EDE8DF;--accent-hover:#F0EDE6;--green-btn:#EDE8DF;--green-hover:#F0EDE6;--green-accent:#EDE8DF;--green-bright:#E8E4DC;--blue:#E8E4DC;--orange:#f0883e;--red:#f87171;--purple:#bc8cff;}
*{margin:0;padding:0;box-sizing:border-box;}html{scroll-behavior:smooth;}
body{background:var(--bg-canvas);color:var(--text-primary);font-family:'Space Grotesk',sans-serif;line-height:1.5;min-height:100vh;}
h1,h2,h3{font-family:'Archivo Black',sans-serif;color:var(--accent);}

.page-wrap{max-width:1100px;margin:0 auto;padding:40px 24px;}

/* Header row */
.header-row{display:flex;align-items:center;gap:12px;margin-bottom:28px;flex-wrap:wrap;}
.header-row h1{font-size:24px;font-weight:700;flex:1;}
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;}
input[type=text],select{background:var(--bg-inset);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text-primary);font-size:13px;outline:none;transition:border-color .15s;}
input[type=text]:focus,select:focus{border-color:var(--blue);}

/* Beat cards grid */
.beats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;}

/* Beat card */
.beat-card{background:rgba(22,27,34,.75);border:1px solid rgba(48,54,61,.7);border-radius:12px;overflow:hidden;transition:border-color .2s,transform .2s;}
.beat-card:hover{border-color:rgba(237,232,223,.4);transform:translateY(-2px);}
.beat-waveform{height:72px;background:var(--bg-inset);position:relative;overflow:hidden;cursor:pointer;}
.beat-waveform .viz-wrap{position:absolute;top:0;left:0;width:100%;height:100%;}
.beat-waveform .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:22px;opacity:0;transition:opacity .15s;background:rgba(0,0,0,.3);}
.beat-waveform:hover .play-overlay{opacity:1;}
.beat-body{padding:14px;}
.beat-name{font-weight:600;font-size:14px;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.beat-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;}
.tag{display:inline-flex;padding:2px 8px;border-radius:99px;font-size:11px;}
.tag-green{background:rgba(237,232,223,.12);border:1px solid rgba(237,232,223,.25);color:var(--green-accent);}
.tag-blue{background:rgba(88,166,255,.1);border:1px solid rgba(88,166,255,.2);color:var(--blue);}
.tag-orange{background:rgba(240,136,62,.1);border:1px solid rgba(240,136,62,.2);color:var(--orange);}
.tag-purple{background:rgba(188,140,255,.1);border:1px solid rgba(188,140,255,.2);color:var(--purple);}
.beat-meta{font-size:11px;color:var(--text-muted);margin-bottom:12px;}
.beat-actions{display:flex;gap:6px;}
.beat-actions button{flex:1;padding:5px 0;font-size:12px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text-primary);transition:all .15s;}
.beat-actions button:hover{background:rgba(177,186,196,.1);}

/* Empty state */
.empty-state{text-align:center;padding:80px 20px;color:var(--text-muted);}
.empty-state .icon{font-size:4rem;margin-bottom:16px;}

/* Modal */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;}
.modal-backdrop.open{display:flex;}
.modal{background:var(--bg-overlay);border:1px solid var(--border);border-radius:16px;width:420px;max-width:93vw;overflow:hidden;}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.modal-header h3{font-size:16px;font-weight:600;}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;padding:4px;line-height:1;}
.modal-body{padding:20px;}
.form-row{margin-bottom:14px;}
.form-row label{display:block;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-bottom:5px;}
.form-row select,.form-row input{width:100%;}
.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;}
.status-msg{font-size:12px;padding:7px 10px;border-radius:6px;margin-bottom:12px;}
.status-msg.ok{background:rgba(63,185,80,.1);color:var(--green-accent);}
.status-msg.err{background:rgba(248,81,73,.1);color:var(--red);}

.fade-in{opacity:0;transform:translateY(14px);transition:opacity .4s,transform .4s;}
.fade-in.visible{opacity:1;transform:none;}
.skeleton{background:rgba(48,54,61,.5);border-radius:8px;animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:.4;}50%{opacity:.8;}}
</style>
</head>
<body>
<div id="nav-root"></div>

<div class="page-wrap">
<div class="header-row fade-in">
<h1>My Library</h1>
<div class="filter-bar">
<input type="text" id="lib-search" placeholder="Filter beats…" oninput="filterBeats(this.value)" style="width:180px;">
<select id="lib-mood" onchange="filterBeats()">
<option value="">All Moods</option>
<option value="EDM / Club Banger">EDM / Club Banger</option>
<option value="Trap / Hip-Hop">Trap / Hip-Hop</option>
<option value="Lo-fi Chill">Lo-fi Chill</option>
<option value="Synthwave">Synthwave</option>
<option value="Deep House">Deep House</option>
<option value="Drum and Bass">Drum and Bass</option>
<option value="Ambient">Ambient</option>
<option value="Phonk">Phonk</option>
<option value="Calm Piano">Calm Piano</option>
<option value="Acoustic Guitar">Acoustic Guitar</option>
<option value="Jazz">Jazz</option>
<option value="Blues">Blues</option>
<option value="Orchestral">Orchestral</option>
<option value="R&amp;B / Soul">R&amp;B / Soul</option>
<option value="Epic Cinematic">Epic Cinematic</option>
<option value="Metal">Metal</option>
<option value="Indie Rock">Indie Rock</option>
<option value="Afrobeats">Afrobeats</option>
<option value="Meditation">Meditation</option>
<option value="Nature Sounds">Nature Sounds</option>
<option value="Sleep Drone">Sleep Drone</option>
<option value="Bossa Nova">Bossa Nova</option>
<option value="8-Bit Game">8-Bit Game</option>
<option value="Middle Eastern">Middle Eastern</option>
</select>
<select id="lib-bpm" onchange="filterBeats()">
<option value="">All BPM</option>
<option value="slow">Slow (40–80)</option>
<option value="medium">Medium (80–120)</option>
<option value="fast">Fast (120–180)</option>
<option value="very_fast">Very Fast (180+)</option>
</select>
<select id="lib-sort" onchange="sortBeats(this.value)">
<option value="newest">Newest</option>
<option value="oldest">Oldest</option>
<option value="bpm_asc">BPM ↑</option>
<option value="bpm_desc">BPM ↓</option>
</select>
</div>
</div>
<div id="lib-count" style="font-size:13px;color:var(--text-muted);margin-bottom:16px;"></div>
<div class="beats-grid" id="beats-grid">
  ${[1,2,3,4,5,6].map(()=>`<div class="beat-card"><div class="skeleton" style="height:64px;border-radius:0;"></div><div style="padding:14px;"><div class="skeleton" style="height:14px;width:70%;margin-bottom:8px;"></div><div class="skeleton" style="height:10px;width:50%;margin-bottom:12px;"></div><div class="skeleton" style="height:28px;border-radius:6px;"></div></div></div>`).join('')}
</div>
<div class="empty-state" id="empty-state" style="display:none;">
<div class="icon"></div>
<div style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">Your library is empty</div>
<div style="font-size:14px;margin-bottom:20px;">Generate beats in Studio and save them to your library</div>
<a href="studio.html" class="btn btn-green">Open Studio</a>
</div>
</div>

<!-- Add to Project Modal -->
<div class="modal-backdrop" id="add-modal" onclick="bgClose(event)">
<div class="modal">
<div class="modal-header">
<h3>Add Beat to Project</h3>
<button class="modal-close" onclick="closeAddModal()">✕</button>
</div>
<div class="modal-body">
<div id="add-status" style="display:none;"></div>
<div class="form-row">
<label>Select Project</label>
<select id="modal-project-select" style="width:100%;"></select>
</div>
<div class="form-row">
<label>Commit Message</label>
<input type="text" id="modal-commit-msg" placeholder="e.g. Added library beat" style="width:100%;"/>
</div>
<input type="hidden" id="modal-audio-file"/>
<input type="hidden" id="modal-beat-name"/>
</div>
<div class="modal-footer">
<button class="btn btn-ghost btn-sm" onclick="closeAddModal()">Cancel</button>
<button class="btn btn-green btn-sm" onclick="doAddToProject()">Add to Project</button>
</div>
</div>
</div>

<script>
const API='http://localhost:8000';
const token=localStorage.getItem('bf_token');
let _allBeats=[];
let _projects=[];
let _currentAudio=null;
let _currentPlayId=null;
// Pre-init visualizer queue
window._vizQueue = window._vizQueue || [];

function signOut(){localStorage.removeItem('bf_token');localStorage.removeItem('bf_user');location.href='index.html';}
function authH(){return{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'};}
function timeAgo(ts){const d=new Date(ts);const s=Math.floor((Date.now()-d)/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}

function tagColor(mood){const map={happy:'tag-orange',chill:'tag-blue',dark:'tag-purple',aggressive:'tag-orange',melancholic:'tag-purple',upbeat:'tag-green'};return map[mood]||'tag-green';}

function drawWaveformCanvas(canvas,data){
  const ctx=canvas.getContext('2d');
  const W=canvas.width=canvas.offsetWidth||280;
  const H=canvas.height=64;
  ctx.clearRect(0,0,W,H);
  const bars=Math.floor(W/4);
  const gradient=ctx.createLinearGradient(0,0,W,0);
  gradient.addColorStop(0,'#238636');gradient.addColorStop(1,'var(--accent-hover)');
  ctx.fillStyle=gradient;
  for(let i=0;i<bars;i++){
  const v=data?data[i%data.length]||0.3:0.3+Math.sin(i*0.4)*0.2+Math.random()*0.15;
  const h=Math.max(4,v*H*0.85);
  ctx.fillRect(i*4,H/2-h/2,3,h);
  }
}

function renderBeats(beats){
  const grid=document.getElementById('beats-grid');
  const empty=document.getElementById('empty-state');
  document.getElementById('lib-count').textContent=beats.length+' beat'+(beats.length!==1?'s':'');
  if(!beats.length){grid.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  grid.innerHTML=beats.map((b,i)=>{
  const name=b.commit_message||b.name||('Beat #'+(i+1));
  const bpm=b.bpm;const key=b.key;const mood=b.mood;const dur=b.duration;
  const date=b.created_at?timeAgo(b.created_at):'';
  const audioUrl=b.audio_url||b.file_path||'';
  return `<div class="beat-card fade-in" id="beat-card-${b.id}">
<div class="beat-waveform" onclick="togglePlay('${b.id}','${API+audioUrl}')">
<div class="viz-wrap" id="vw-${b.id}"></div>
<audio id="lib-audio-${b.id}" src="${API+audioUrl}" preload="none" style="display:none;"></audio>
<div class="play-overlay" id="play-${b.id}">▶</div>
</div>
<div class="beat-body">
<div class="beat-name" title="${name}">${name}</div>
<div class="beat-tags">
  ${bpm?`<span class="tag tag-green">${Math.round(bpm)} BPM</span>`:''}
  ${key?`<span class="tag tag-blue">${key}</span>`:''}
  ${mood?`<span class="tag ${tagColor(mood)}">${mood}</span>`:''}
  ${dur?`<span class="tag tag-purple">${Number(dur).toFixed(0)}s</span>`:''}
</div>
<div class="beat-meta">${date?`Saved ${date}`:'Saved'}</div>
<div class="beat-actions">
<button onclick="location.href='studio.html'" title="Open in Studio">Studio</button>
<button onclick="openAddModal('${audioUrl}','${name.replace(/'/g,'')}','${b.id}')" title="Add to Project">Project</button>
  ${audioUrl?`<a href="${API+audioUrl}" download style="flex:1;text-align:center;padding:5px 0;font-size:12px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text-primary);text-decoration:none;transition:all .15s;" onmouseover="this.style.background='rgba(177,186,196,.1)'" onmouseout="this.style.background='transparent'">⬇ Download</a>`:''}
</div>
</div>
</div>`;
  }).join('');
  // Mount animated visualizers + observe
  beats.forEach(b=>{
    window._vizQueue.push({ wrapId:'vw-'+b.id, audioId:'lib-audio-'+b.id, height:72 });
  });
  observeFadeIns();
}

function togglePlay(id,audioUrl){
  const overlay=document.getElementById('play-'+id);
  const audio=document.getElementById('lib-audio-'+id);
  if(!overlay) return;
  if(_currentPlayId===id&&audio&&!audio.paused){
    audio.pause();overlay.textContent='▶';_currentPlayId=null;return;
  }
  if(_currentAudio){_currentAudio.pause();if(_currentPlayId){const old=document.getElementById('play-'+_currentPlayId);if(old)old.textContent='▶';}}
  if(audio){
    _currentAudio=audio;_currentPlayId=id;
    overlay.textContent='⏸';
    audio.play().catch(()=>{});
    audio.onended=()=>{overlay.textContent='▶';_currentPlayId=null;};
  }
}

/* ── Filters ─────────────────────────────────────────────────── */
function filterBeats(searchOverride){
  const q=(searchOverride!==undefined?searchOverride:document.getElementById('lib-search').value).toLowerCase();
  const mood=document.getElementById('lib-mood').value;
  const bpmRange=document.getElementById('lib-bpm').value;
  const bpmMap={slow:[40,80],medium:[80,120],fast:[120,180],very_fast:[180,300]};
  const range=bpmMap[bpmRange];
  let filtered=_allBeats;
  if(q) filtered=filtered.filter(b=>(b.commit_message||b.name||'').toLowerCase().includes(q));
  if(mood) filtered=filtered.filter(b=>b.mood===mood);
  if(range) filtered=filtered.filter(b=>b.bpm&&b.bpm>=range[0]&&b.bpm<range[1]);
  renderBeats(filtered);
}

function sortBeats(by){
  const before=_allBeats.slice();
  if(by==='newest') _allBeats.sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));
  if(by==='oldest') _allBeats.sort((a,b)=>new Date(a.created_at||0)-new Date(b.created_at||0));
  if(by==='bpm_asc') _allBeats.sort((a,b)=>(a.bpm||0)-(b.bpm||0));
  if(by==='bpm_desc') _allBeats.sort((a,b)=>(b.bpm||0)-(a.bpm||0));
  filterBeats();
}

/* ── Add to Project modal ─────────────────────────────────────── */
function openAddModal(audioFile,beatName,beatId){
  document.getElementById('modal-audio-file').value=audioFile;
  document.getElementById('modal-beat-name').value=beatName;
  document.getElementById('modal-commit-msg').value=`Added: ${beatName}`;
  document.getElementById('add-status').style.display='none';
  // Load projects
  const sel=document.getElementById('modal-project-select');
  sel.innerHTML='<option>Loading…</option>';
  fetch(`${API}/projects`,{headers:authH()}).then(r=>r.json()).then(d=>{
  const repos=d.repositories||d||[];
  _projects=repos;
  sel.innerHTML=repos.map(r=>`<option value="${r.id}">${r.name}</option>`).join('')||'<option>No projects found</option>';
  }).catch(()=>{sel.innerHTML='<option>Failed to load</option>';});
  document.getElementById('add-modal').classList.add('open');
}
function closeAddModal(){document.getElementById('add-modal').classList.remove('open');}
function bgClose(e){if(e.target.id==='add-modal')closeAddModal();}

async function doAddToProject(){
  const repoId=document.getElementById('modal-project-select').value;
  const msg=document.getElementById('modal-commit-msg').value.trim()||'Added beat from library';
  const audioFile=document.getElementById('modal-audio-file').value;
  const statusEl=document.getElementById('add-status');
  if(!repoId){statusEl.className='status-msg err';statusEl.textContent='Select a project.';statusEl.style.display='block';return;}
  try{
  const body={message:msg,audio_file:audioFile};
  const r=await fetch(`${API}/projects/${repoId}/commit`,{method:'POST',headers:authH(),body:JSON.stringify(body)});
  if(!r.ok){const e=await r.json();throw new Error(e.detail||r.status);}
  statusEl.className='status-msg ok';statusEl.textContent='✓ Added to project!';statusEl.style.display='block';
  setTimeout(closeAddModal,1500);
  }catch(e){statusEl.className='status-msg err';statusEl.textContent='✗ '+e.message;statusEl.style.display='block';}
}

/* ── Load library ────────────────────────────────────────────── */
async function loadLibrary(){
  try{
  const mr=await fetch(`${API}/auth/me`,{headers:authH()});
  if(mr.ok){const u=await mr.json();document.getElementById('nav-username').textContent=u.username||'';}
  }catch{}
  try{
  const r=await fetch(`${API}/library`,{headers:authH()});
  if(!r.ok)throw new Error(r.status);
  const d=await r.json();
  _allBeats=(d.beats||d||[]).sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));
  renderBeats(_allBeats);
  }catch(e){
  document.getElementById('beats-grid').innerHTML=`<div style="grid-column:1/-1;color:var(--red);font-size:13px;padding:40px 0;text-align:center;">Failed to load library: ${e.message}</div>`;
  }
}

function observeFadeIns(){
  const obs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting)e.target.classList.add('visible');});},{threshold:.05});
  document.querySelectorAll('.fade-in:not(.visible)').forEach(el=>obs.observe(el));
}
document.querySelectorAll('.fade-in').forEach(el=>{new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting)e.target.classList.add('visible');});},{threshold:.05}).observe(el);});
loadLibrary();
</script>
<script src="nav.js"></script>
<script type="module" src="./visualizer.js"></script>
</body>
</html>
